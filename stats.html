<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.min.css">
  <title>nwHacks Live Registration Stats</title>
  <meta name="viewport" content="width=device-width">
  <style>
    h1, h2, h3, p, canvas {
      margin-left: 16px;
      margin-right: 16px;
    }
    .chart-container {
      margin: 0;
      width: 100%;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>
    nwHacks Live Registration Stats
  </h1>
  <p class="flow-text">This page refreshes every 5 minutes. If the page doesn't load you might need to <a href="/api/admin/login/?next=/static/stats.html">login</a>.</p>
  <p class="flow-text">Total Registrations: <span id="registrations">Loading...</span>,
  De-duplicated (by email): <span id="regDeDup">Loading...</span>,
  Accepted: <span id="accepted">Loading...</span>
  </p>
  <h2>University</h2>
  <div class="chart-container">
    <canvas id="university" width="3000" height="700"></canvas>
  </div>
  <h2>City</h2>
  <div class="chart-container">
    <canvas id="city" width="3000" height="700"></canvas>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/js/materialize.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.1/lodash.min.js"></script>

  <script>
    var patterns = {
      'University of British Columbia': [
        'UBC', 'University of British Columbia', 'University of the British Columbia', 'University of British Colombia', 'university british columbia'
      ],
      'Simon Fraser University': ['SFU', 'Simon Fraser', 'Somion Fraser'],
      'University of Waterloo': ['Waterloo'],
      'BCIT': ['BCIT', 'British Columbia Institute of Technology'],
      'University of Illinois Urbana-Champaign': ['Urbana-Champaign', 'Urbana Champaign'],
      'McGill University': ['McGill'],
      'University of Washington': ['University of Washington', 'UW', 'University of Washingon'],
    }
    var patternsCities = {
      'Vancouver': [
        'UBC', 'University of British Columbia', 'Vanouver', 'Vancouver', 'Gage', 'Marine Drive', 'Locally', 'Vancover', 'Campus', 'N/a', 'University of the British Columbia', 'University of British Colombia', 'university british columbia',
      ],
      'Seattle': ['University of Washington'],
    }
    var charts = [];
    function fetchData() {
      $.get('/api/register/', function(data) {
        renderData(data);
      });
    }

    fetchData();
    setInterval(fetchData, 5*60*1000);

    function renderData(data) {
      data.sort(function(a,b) {
        return b.id-a.id;
      });
      _.each(charts, function(chart) {
        chart.destroy();
      });
      charts = [];
      document.getElementById("registrations").innerText = data.length;
      var univs = {};
      var students = {};
      var cities = {};
      var deDupStudents = 0;
      var acceptedStudents = 0;
      _.each(data, function(datum) {
        // Cleanup step
        _.each(patterns, function(pattern, remap) {
          _.each(pattern, function(p) {
            if (datum.school.toLowerCase().trim().indexOf(p.toLowerCase()) >= 0) {
              datum.school = remap;
            }
          });
        });
        _.each(patternsCities, function(pattern, remap) {
          _.each(pattern, function(p) {
            if (datum.city.toLowerCase().trim().indexOf(p.toLowerCase()) >= 0) {
              datum.city = remap;
            }
          });
        });

        var email = datum.email.toLowerCase().trim();
        if (students[email] && datum.status != 1 || students[email] && students[email].status == 1) {
          return;
        }
        deDupStudents++;
        students[email] = datum;

        if (!univs[datum.school]) {
          univs[datum.school] = {
            name: datum.school,
            accepted: 0,
            total: 0
          };
        }
        univs[datum.school].total += 1;
        var location = toTitleCase(datum.city.split(',')[0].trim());
        if (!cities[location]) {
          cities[location] = {
            name: location,
            accepted: 0,
            total: 0
          }
        }
        cities[location].total += 1;
        if (datum.status == 1) {
          univs[datum.school].accepted += 1;
          cities[location].accepted += 1;
          acceptedStudents++;
        }
      });

      document.getElementById("regDeDup").innerText = deDupStudents;
      document.getElementById("accepted").innerText = acceptedStudents;

      // Univerisities
      var data = {
        labels: [],
        datasets: [
        {
          label: "Total Students",
          fillColor: "rgba(220,0,0,0.5)",
          strokeColor: "rgba(220,0,0,0.8)",
          highlightFill: "rgba(220,0,0,0.75)",
          highlightStroke: "rgba(20,0,0,1)",
          data: []
        },
        {
          label: "Accepted Students",
          fillColor: "rgba(0,0,220,0.5)",
          strokeColor: "rgba(0,0,220,0.8)",
          highlightFill: "rgba(0,0,220,0.75)",
          highlightStroke: "rgba(0,0,220,1)",
          data: []
        },
        ]
      };
      var sortedUnivs = _(univs).toArray().sortBy('accepted').reverse().value();
      _.each(sortedUnivs, function(v) {
        data.labels.push(v.name);
        data.datasets[0].data.push(v.total);
        data.datasets[1].data.push(v.accepted);
      });
      var ctx = document.getElementById("university").getContext("2d");
      charts.push(new Chart(ctx).Bar(data, {}));

      // Cities

      var dataCities = {
        labels: [],
        datasets: [
        {
          label: "Total Students",
          fillColor: "rgba(0,220,0,0.5)",
          strokeColor: "rgba(0,220,0,0.8)",
          highlightFill: "rgba(0,220,0,0.75)",
          highlightStroke: "rgba(0,220,0,1)",
          data: []
        },
        {
          label: "Accepted Students",
          fillColor: "rgba(0,0,220,0.5)",
          strokeColor: "rgba(0,0,220,0.8)",
          highlightFill: "rgba(0,0,220,0.75)",
          highlightStroke: "rgba(0,0,220,1)",
          data: []
        },
        ]
      };
      var sortedCities = _(cities).toArray().sortBy('accepted').reverse().value();
      _.each(sortedCities, function(v) {
        dataCities.labels.push(v.name);
        dataCities.datasets[0].data.push(v.total);
        dataCities.datasets[1].data.push(v.accepted);
      });
      var ctx = document.getElementById("city").getContext("2d");
      charts.push(new Chart(ctx).Bar(dataCities, {}));
    }
    // https://stackoverflow.com/questions/4878756/javascript-how-to-capitalize-first-letter-of-each-word-like-a-2-word-city
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }
  </script>
</body>
