<dom-module id="select-hackers">
  <template>
    <style>
      paper-card {
        color: black;
        max-width: 900px;
      }
      table {
        text-align: left;
        width: 100%;
      }
      a {
        color: green;
      }
      .tag {
        color: green;
        font-weight: bold;
        display: inline-block;
        padding: 5px;
        margin: 5px;
        border: 2px solid green;
      }
    </style>
    <h1>Select Hackers</h1>
    <div class="content">
      <paper-card heading="Filters">
        <div class="card-content">
          <paper-dropdown-menu label="Status" selected-item-label="{{status}}">
            <paper-listbox class="dropdown-content" selected="[[selected(hacker.status)]]">
              <paper-item>All</paper-item>
              <template is="dom-repeat" items="[[categories]]">
                <paper-item>[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </paper-card>
    </div>
    <template is="dom-repeat" items="{{hackers}}" as="hacker" filter="{{filter(status)}}" observe="status">
      <paper-card heading="[[title(hacker)]]">
        <div class="card-content">
          <table>
            <thead>
              <th> School </th>
              <th>City</th>
              <th>GitHub</th>
              <th>LinkedIn</th>
              <th>Personal Site</th>
              <th>Resume</th>
              <th>T-Shirt Size</th>
            </thead>
            <tbody>
              <tr>
                <td>[[hacker.school]]</td>
                <td>[[hacker.city]]</td>
                <td><a target="_blank" href="[[githubLink(hacker.github)]]">[[hacker.github]]</a></td>
                <td><a target="_blank" href="[[linkedinLink(hacker.linkedin)]]">[[hacker.linkedin]]</a></td>
                <td><a target="_blank" href="[[hacker.personalsite]]">[[hacker.personalsite]]</a></td>
                <td><a target="_blank" href="[[hacker.resume]]">[[hacker.resume]]</a></td>
                <td>[[hacker.tshirt]]</td>
              </tr>
            </tbody>
          </table>
          <h3>Reason</h3>
          <p>[[hacker.reason]]</p>

          <template is="dom-if" if="[[hacker.travel_reimbursement]]">
            <div class="tag">Travel Reimbursement</div>
          </template>
          <template is="dom-if" if="[[hacker.first_hackathon]]">
            <div class="tag">First Hackathon</div>
          </template>
          <template is="dom-if" if="[[hacker.mentor]]">
            <div class="tag">Wants to Mentor</div>
          </template>
          </table>
        </div>
        <div class="card-actions">
          <paper-dropdown-menu label="Status">
            <paper-listbox class="dropdown-content" selected="[[selected(hacker.status)]]" on-iron-select="onSelect">
              <template is="dom-repeat" items="[[categories]]">
                <paper-item>[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </paper-card>
    </template>
    <iron-ajax auto url="/api/register/" handle-as="json" last-response="{{hackers}}"></iron-ajax>
  </template>
  <script>
'use strict';
const categories = ['applied', 'accepted', 'waitlisted', 'rejected'];
Object.freeze(categories);
Polymer({
  is: "select-hackers",

  properties: {
    hackers: {
      type: Array,
      value: [],
    },
    status: {
      type: String,
      value: '',
    },
    categories: {
      type: Array,
      value: categories,
    },
  },
  observers: [
    'hackersChange(hackers)'
  ],
  hackersChange: function(hackers) {
    $.each(hackers, function(i, hacker) {
      if (!hacker.status) {
        hacker.status = 'applied';
      } else {
        hacker.status = categories[hacker.status];
      }
      hacker.index = i;
    });
  },
  title: function(hacker) {
    return hacker.name + ' ('+hacker.email+')';
  },
  filter: function(status) {
    return function(hacker) {
      return status === '' || status === 'null' || status === 'All' || status === hacker.status;
    };
  },
  githubLink: function(username) {
    return 'https://github.com/' + username;
  },
  linkedinLink: function(username) {
    return 'https://linkedin.com/in/' + username;
  },
  selected: function(status) {
    var index = categories.indexOf(status);
    if (index >= 0) {
      return index;
    }
    return 0;
  },
  onSelect: function(e) {
    var index = e.target.selected;
    var status = categories[index];
    var hacker = e.model.hacker;
    if (hacker.status !== status) {
      console.log(hacker.status, status);
      this.set('hackers.'+hacker.index+'.status',status);

      /*var data = jQuery.extend(true, {}, hacker);
      delete data.resume;
      delete data.index;
      */

      var data = {
        status: categories.indexOf(hacker.status),
      };
      $.ajax({
        url : '/api/register/'+hacker.id+'/',
        type : 'PATCH',
        data : data,
      }).done(function(e) {
        console.log('done', e);
      }).fail(function(e) {
        console.log('error', e)
        alert( "error");
      });
    }
  }
});
  </script>
</dom-module>
