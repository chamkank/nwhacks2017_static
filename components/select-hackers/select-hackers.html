<dom-module id="select-hackers">
  <template>
    <style>
      iron-list {
        margin-top: 20px;
        height: 1000px;
      }
      paper-input {
        display: inline-block;
      }
      paper-card {
        color: black;
        max-width: 900px;
        margin: 20px auto;
      }
      table {
        text-align: left;
        width: 100%;
        table-layout: fixed;
      }
      a {
        color: green;
      }
      .tag {
        color: green;
        font-weight: bold;
        display: inline-block;
        padding: 5px;
        margin: 5px;
        border: 2px solid green;
      }
      .tag.bad {
        color: red;
        border-color: red;
      }
      .right {
        float: right;
      }
    </style>
    <h1>Select Hackers</h1>
    <div class="content">
      <paper-card>
        <div class="card-content">
          Filters &nbsp;
          <paper-dropdown-menu label="Status" selected-item-label="{{status}}">
            <paper-listbox class="dropdown-content" selected="[[selected(hacker.status)]]">
              <paper-item>All</paper-item>
              <template is="dom-repeat" items="[[categories]]">
                <paper-item>[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          &nbsp;
          <paper-input label="Search" value="{{search}}"></paper-input>


          &nbsp;
          Showing
          <span>{{filteredCount}}</span>
          of
          <span>{{totalCount}}</span>

          <br>
          <paper-checkbox checked="{{filterMentor}}">Wants to Mentor</paper-checkbox> &nbsp;
          <paper-checkbox checked="{{filterFirst}}">First Time</paper-checkbox> &nbsp;
          <paper-checkbox checked="{{filterReimbursement}}">Needs Reimbursement</paper-checkbox> &nbsp;
        </div>
      </paper-card>
    </div>
    <!-- <template is="dom-repeat" items="{{hackers}}" as="hacker" filter="{{filter(status)}}" observe="status"> -->
    <iron-list items="[[filter(hackers, status, search, filterMentor, filterFirst, filterReimbursement, incr)]]" as="hacker">
      <template>
        <div>
          <paper-card heading="[[title(hacker)]]">
            <div class="card-content">
              <table>
                <thead>
                  <th> School </th>
                  <th>City</th>
                  <th>GitHub</th>
                  <th>LinkedIn</th>
                  <th>Personal Site</th>
                  <th>Resume</th>
                  <th>T-Shirt Size</th>
                </thead>
                <tbody>
                  <tr>
                    <td>[[hacker.school]]</td>
                    <td>[[hacker.city]]</td>
                    <td><a target="_blank" href="[[githubLink(hacker.github)]]">[[hacker.github]]</a></td>
                    <td><a target="_blank" href="[[linkedinLink(hacker.linkedin)]]">[[hacker.linkedin]]</a></td>
                    <td><a target="_blank" href="[[hacker.personalsite]]">[[hacker.personalsite]]</a></td>
                    <td>
                      <template is="dom-if" if="[[hacker.resume]]">
                        <a target="_blank" href="[[hacker.resume]]">Resume</a>
                      </template>
                    </td>
                    <td>[[hacker.tshirt]]</td>
                  </tr>
                </tbody>
              </table>
              <h3>Why do you want to come to nwHacks?</h3>
              <p>[[hacker.reason]]</p>

              <template is="dom-if" if="[[hacker.travel_reimbursement]]">
                <div class="tag">Travel Reimbursement</div>
              </template>
              <template is="dom-if" if="[[hacker.first_hackathon]]">
                <div class="tag">First Hackathon</div>
              </template>
              <template is="dom-if" if="[[hacker.mentor]]">
                <div class="tag">Wants to Mentor</div>
              </template>
              <template is="dom-if" if="[[hacker.duplicate]]">
                <div class="tag bad">Multiple Submissions</div>
              </template>
              </table>
            </div>
            <div class="card-actions">
              <select selected="{{selected(hacker.status)}}" on-change="onSelect">
                <template is="dom-repeat" items="[[categories]]">
                  <option selected$="[[eq(item, hacker.status)]]">[[item]]</option>
                </template>
              </select>
              <span class="right">#<span>[[hacker.id]]</span></span>
            </div>
          </paper-card>
        </div>
      </template>
    </iron-list>
    <iron-ajax auto url="/api/register/" handle-as="json" on-response="handleResponse"></iron-ajax>
  </template>
  <script>
'use strict';
const categories = ['applied', 'accepted', 'waitlisted', 'rejected'];
Object.freeze(categories);
Polymer({
  is: "select-hackers",

  properties: {
    hackers: {
      type: Array,
      value: [],
    },
    status: {
      type: String,
      value: '',
    },
    incr: {
      type: Number,
      value: 0,
    },
    categories: {
      type: Array,
      value: categories,
    },
  },
  observers: [
    'hackersChange(hackers)'
  ],
  handleResponse: function(e, req) {
    var hackers = req.xhr.response;
    hackers.sort(function(a, b) {
      return a.id - b.id;
    });
    var dedup = {};
    hackers.forEach(function(hacker) {
      var email = hacker.email.toLowerCase().trim();
      dedup[email] = (dedup[email] || 0) + 1;
    });
    hackers.forEach(function(hacker) {
      var email = hacker.email.toLowerCase().trim();
      if (dedup[email] > 1) {
        hacker.duplicate = true;
      }
    });
    this.hackers = hackers;
  },
  cleanEmail: function(email) {
  },
  hackersChange: function(hackers) {
    this.lunr = lunr(function () {
      this.ref('index')
      this.field('city');
      this.field('email');
      this.field('github');
      this.field('personalsite');
      this.field('linkedin');
      this.field('name');
      this.field('reason');
      this.field('school')
    });
    var self = this;
    $.each(hackers, function(i, hacker) {
      if (!hacker.status) {
        hacker.status = 'applied';
      } else {
        hacker.status = categories[hacker.status];
      }
      hacker.index = i;
      self.lunr.add(hacker);
    });
  },
  title: function(hacker) {
    return hacker.name + ' ('+hacker.email+')';
  },
  filter: function(hackers, status, search, filterMentor, filterFirst, filterReimbursement) {
    var results = hackers;
    this.totalCount = hackers.length;
    if (search.length > 0) {
      var rawResults = this.lunr.search(search);
      results = rawResults.map(function(result) {
        return hackers[result.ref];
      });
    }
    var filtered = results.filter(function(hacker, b, c) {
      var good = status === '' || status === 'null' || status === 'All' || status === hacker.status;
      if (filterMentor) {
        good = good && hacker.mentor;
      }
      if (filterReimbursement) {
        good = good && hacker.travel_reimbursement;
      }
      if (filterFirst) {
        good = good && hacker.first_hackathon;
      }
      return good
    });
    this.filteredCount = filtered.length;
    return filtered;
  },
  githubLink: function(username) {
    if (username.indexOf('github.com') > 0) {
      return username;
    }
    return 'https://github.com/' + username;
  },
  linkedinLink: function(username) {
    if (username.indexOf('linkedin.com') > 0) {
      return username;
    }
    return 'https://linkedin.com/in/' + username;
  },
  selected: function(status) {
    var index = categories.indexOf(status);
    if (index >= 0) {
      return index;
    }
    return 0;
  },
  eq: function(a, b) {
    return a === b;
  },
  onSelect: function(e) {
    var index = e.target.selectedIndex;
    var status = categories[index];
    var hacker = e.model.hacker;
    if (hacker.status !== status) {
      console.log(hacker);
      this.set('hackers.'+hacker.index+'.status',status);

      var data = {
        status: categories.indexOf(hacker.status),
      };
      $.ajax({
        url : '/api/register/'+hacker.id+'/',
        type : 'PATCH',
        data : data,
      }).done(function(e) {
        console.log('done', e);
      }).fail(function(e) {
        console.log('error', e)
        alert( "error");
      });
    }
  },
  refreshList: function() {
    this.incr++;
  }
});
  </script>
</dom-module>
